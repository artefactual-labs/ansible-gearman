---

- name: "Load OS-specific vars"
  include_vars: "{{ ansible_os_family }}.yml"
  tags:
    - always

- name: "Install Debian Gearman packages"
  apt:
    pkg: "{{ gearman_packages }}"
    state: "present"
    update_cache: "yes"
    cache_valid_time: "3600"
    install_recommends: "no"
  when: ansible_os_family == 'Debian'

# In Rocky 9:
# - Ref. https://wiki.rockylinux.org/rocky/repo/
# - gearmand package is provided by epel repo
#   (epel repo is not configured by default)
# - gearnand depends on libmemcached-awesome, which is provided by crb repo
#   (crb repo is configured in the distro but disabled)
# - We should be able to just run yum with --enablerepo option to 
#   temporarily enable the repos without configuring them to be enabled
#   in the /etc/yum.repos.d/ config files

- name: Install epel-release but disable epel repos
  block:
    - name: Install epel-release
      dnf:
        name: epel-release
    - name: Disable epel repos
      community.general.ini_file:
        path: "{{ item.path }}"
        section: "{{ item.section }}"
        option: enabled
        value: 0
        no_extra_spaces: true
        owner: root
        group: root
        mode: 0644
        backup: true
      loop:
        - path: /etc/yum.repos.d/epel.repo
          section: epel
        - path: /etc/yum.repos.d/epel-cisco-openh264.repo
          section: epel-cisco-openh264
  when:
    - ansible_distribution in ['CentOS','Rocky','AlmaLinux','RedHat']
    - ansible_facts['distribution_major_version'] >= "9"
    - gearman_configure_rpm_repositories|bool

# - name: "Enable crb repo on CentOS/Rocky/Almalinux >= 9"
#   command: "dnf config-manager --set-enabled crb"
#   when:
#     - ansible_distribution in ['CentOS','Rocky','AlmaLinux']
#     - ansible_facts['distribution_major_version'] >= "9"
#     - gearman_configure_rpm_repositories|bool

# - name: "Enable crb repo on OracleLinux >= 9"
#   command: "dnf config-manager --set-enabled ol9_codeready_builder"
#   when:
#     - ansible_distribution in ['OracleLinux']
#     - ansible_facts['distribution_major_version'] >= "9"
#     - gearman_configure_rpm_repositories|bool

# - name: "Enable crb repo on RHEL >= 9"
#   command: "subscription-manager repos --enable=codeready-builder-for-rhel-9-x86_64-rpms"
#   when:
#     - ansible_distribution in ['RedHat']
#     - ansible_facts['distribution_major_version'] >= "9"
#     - gearman_configure_rpm_repositories|bool

- name: "Install Gearman packages"
  yum:
    name: "{{ item.name }}"
    enablerepo: "{{ item.enablerepo | default(omit) }}"
  loop: "{{ gearman_packages }}"
  when: ansible_os_family == 'RedHat'

- name: "Populate gearman defaults"
  template:
    src: "{{ gearman_config_src }}"
    dest: "{{ gearman_config_dest }}"
    owner: "root"
    group: "root"
    mode: "0644"
    backup: true
  notify:
    - "Restart gearman"

- name: "Install Gearman service"
  template:
    src: "etc/init/gearman-job-server.conf"
    dest: "/etc/init/gearman-job-server.conf"
    owner: "root"
    group: "root"
  notify:
    - "Restart gearman"
  when:
    - ansible_service_mgr == "upstart"

- name: "Ensure that gearman is enabled and running"
  service:
    name: "{{ gearman_service }}"
    enabled: "yes"
    state: "started"

- name: "Flush handlers"
  meta: flush_handlers
